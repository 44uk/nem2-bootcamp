# マルチシグアカウント

マルチシグアカウントとは、マルチシグアカウントからのトランザクションに関して、複数の連署者というトランザクションの発行に承認能力を持つアカウントを追加する機能です。

- [マルチシグアカウント — NEM Developer Center](https://nemtech.github.io/ja/concepts/multisig-account.html#multisig-account)


## マルチシグアカウントの用途

マルチシグアカウントとなったアカウントはそれ自信からトランザクションを発行することができなくなり、トランザクションの発信は連署者より行うことになります。

マルチシグアカウントに関連する連署者は後から追加・削減することができます。

- 共有アカウントからのモザイク送信の承認・否認ロジック
- アカウントの譲渡

アカウントの譲渡とは、連署者を付け替えることでマルチシグアカウントの所有者を移し替えるテクニックです。


## マルチシグアカウントへの変換

`scripts/multisig/convert_multisig.js`を実行してください。

このスクリプトはアカウントを3つ生成し、そのうち1つをマルチシグアカウントに、

2つと環境変数に設定している秘密鍵のアカウントを連署者として設定します。

```shell
$ node scripts/multisig/convert_multisig.js
Initiater: SCGUWZ-FCZDKI-QCACJH-KSMRT7-R75VY6-FQGJOU-EZN5
Endpoint:  http://localhost:3000/account/SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5

Multisig Account
Private:  C49E95DCFF32F43A72CE1E7ABE4A1CAA48CE87573889A54161F0C6069F169CA2
Public:   F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6
Address:  SDGQ6R-TCBE7S-3LTTXG-7YVMAB-XHJTZD-CF3JWE-5R7A
Endpoint: http://localhost:3000/account/SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A
Endpoint: http://localhost:3000/account/SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A/multisig

Cosigner Account1:
Private:  63C3B2AD116A94591483F60E320BB5A53795F8FCB88AB282BADDC86A0BE69F99
Public:   7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8
Address:  SBV46L-BDJZGK-ETWYS5-6ZT2VV-4RCOMH-KA3NTN-UQSG
Endpoint: http://localhost:3000/account/SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG
Endpoint: http://localhost:3000/account/SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG/multisig

Cosigner Account2:
Private:  3BC214EF814EB288BD04534354CA3BBF37C74E36EAD562142F48BC8CBAD7A927
Public:   043F016A2DE43A1D263EC0953A6157CDDD4F53DEC0A0DE33CB5937AEC9B8CE0A
Address:  SBFMZE-43WQ25-5UPU7O-HRAGZ6-S3SFGE-K7NZ4A-KCBM
Endpoint: http://localhost:3000/account/SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM
Endpoint: http://localhost:3000/account/SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM/multisig

Cosigner Account3:
Private:  25E7E5A21DD0C863B3CC3767C5CC6C081A7C7795BA4115231C74F491A97D6ED7
Public:   64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0
Address:  SCGUWZ-FCZDKI-QCACJH-KSMRT7-R75VY6-FQGJOU-EZN5
Endpoint: http://localhost:3000/account/SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5
Endpoint: http://localhost:3000/account/SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5/multisig

connection open
[Transaction announced]
Endpoint: http://localhost:3000/transaction/791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7
Hash:     791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7
Signer:   F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6

[UNCONFIRMED] SDGQ6R...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:03:11.471"},"fee":{"lower":0,"higher":0},"signature":"3389D48B2FA6D07B6BBC51C9B03E6784BBFC4B27E70475D62D83AB890820ADE1473124DE42873562A36FC80E7F6EFEB8672FA1B6C4E92024729F8A6C1AE9EB0F","signer":{"publicKey":"F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6","address":{"address":"SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7","merkleComponentHash":"791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8","address":{"address":"SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"043F016A2DE43A1D263EC0953A6157CDDD4F53DEC0A0DE33CB5937AEC9B8CE0A","address":{"address":"SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}}}]}

[CONFIRMED] SDGQ6R...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:03:11.471"},"fee":{"lower":0,"higher":0},"signature":"3389D48B2FA6D07B6BBC51C9B03E6784BBFC4B27E70475D62D83AB890820ADE1473124DE42873562A36FC80E7F6EFEB8672FA1B6C4E92024729F8A6C1AE9EB0F","signer":{"publicKey":"F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6","address":{"address":"SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A","networkType":144}},"transactionInfo":{"height":{"lower":5801,"higher":0},"hash":"791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7","merkleComponentHash":"791096425690151D27D88A10FCC4413F9295E39E94C7406CA6A75A1DC58E37E7"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8","address":{"address":"SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"043F016A2DE43A1D263EC0953A6157CDDD4F53DEC0A0DE33CB5937AEC9B8CE0A","address":{"address":"SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}}}]}
```

トランザクションが承認されたら`Multisig Account`のURLにアクセスしてみましょう。

```json
{
    multisig: {
        account: "F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6",
        accountAddress: "90CD0F4662093F2DAE73B9BF8AB001B9D33C8C45DA6C4EC7E0",
        minApproval: 2,
        minRemoval: 2,
        cosignatories: [
            "043F016A2DE43A1D263EC0953A6157CDDD4F53DEC0A0DE33CB5937AEC9B8CE0A",
            "64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0",
            "7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8"
        ],
        multisigAccounts: [ ]
    }
}
```

`cosignatories`の配列に連署者の公開鍵が羅列されていることを確認してみてください。


### コード解説

複数のアカウントをポチポチと`nem2-cli`で作成するのは時間がかかるので、便宜上コード中でアカウントを生成しています。

現実のコードにおいては、連署者として追加するための公開鍵だけがあればよいです。

アカウントを3つ作って、1つ目をマルチシグアカウントへ、後の2つと`alice`を連署者として設定します。

生成したアカウントの秘密鍵はコンソールに表示しているだけなので、適宜リダイレクトや`tee`コマンドでテキストに保存してください。

```javascript
// 連署者とするアカウントの公開アカウントの集合を作る
const cosignerPublicAccounts = cosigners.map((account, idx) => {
  showAccountInfo(account, `Cosigner Account${idx+1}:`)
  return account.publicAccount
})

// 連署者の追加定義集合を作る
const cosignatoryModifications = cosignerPublicAccounts.map(publicAccount => {
  return new nem.MultisigCosignatoryModification(
    nem.MultisigCosignatoryModificationType.Add,
    publicAccount
  );
});

const convertIntoMultisigTx = nem.ModifyMultisigAccountTransaction.create(
  nem.Deadline.create(),
  minApprovalDelta,
  minRemovalDelta,
  cosignatoryModifications,
  nem.NetworkType.MIJIN_TEST
);

util.listener(url, toBeMultisig.address, {
  onOpen: () => {
    const signedTx = toBeMultisig.sign(convertIntoMultisigTx);
    util.announce(url, signedTx);
  },
  onConfirmed: (_, listener) => listener.close()
});
```

各公開鍵とそれを追加・削除を表す値(今回は追加)で`MultisigCosignatoryModification`オブジェクトを作成します。

その集合を使って`ModifyMultisigAccountTransaction`オブジェクトを作成し、署名して発信します。

`minApprovalDelta`はトランザクションを承認するために必要な最小承認数です。

`minRemovalDelta`は連署者を削除するために必要な最小承認数です。

それぞれ増加・減少数を指定する必要があります。

今回は初回の設定なので、設定したい目標数をそのまま指定します。

最後に**マルチシグアカウントに変換したいアカウントの秘密鍵**で署名をして発信します。


## マルチシグアカウントからの送信

マルチシグ化したアカウントはそのアカウントの秘密鍵ではトランザクションを発信することができなくなります。

マルチシグアカウントからトランザクションを発信する場合は連署者となったアカウントからアグリゲートトランザクションを発行します。

スクリプトを実行する前に、マルチシグアカウント化したアカウントへ`10 cat.currency`ほど転送しておいてください。

転送して残高に反映されたら`scripts/multisig/initiate_from_cosigner.js`を実行してください。

このスクリプトは、連署者の秘密鍵、マルチシグアカウントの公開鍵、受信者アドレス、モザイク量を渡します。

ここでは、前の項で作った、連署者として`Cosigner Account1`の秘密鍵を、受信者には`Cosigner Account2`のアドレスを指定しました。

```shell
$ node scripts/multisig/initiate_from_cosigner.js 63C3B2AD116A94591483F60E320BB5A53795F8FCB88AB282BADDC86A0BE69F99 F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6 SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM 1
Initiater:  SCGUWZ-FCZDKI-QCACJH-KSMRT7-R75VY6-FQGJOU-EZN5
Endpoint:   http://localhost:3000/account/SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5
Cosignator: SBV46L-BDJZGK-ETWYS5-6ZT2VV-4RCOMH-KA3NTN-UQSG
Endpoint:   http://localhost:3000/account/SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG
Multisig:   SDGQ6R-TCBE7S-3LTTXG-7YVMAB-XHJTZD-CF3JWE-5R7A
Endpoint:   http://localhost:3000/account/SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A
Amount:     1
Recipient:  SBFMZE-43WQ25-5UPU7O-HRAGZ6-S3SFGE-K7NZ4A-KCBM
Endpoint:   http://localhost:3000/account/SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM

connection open
[Transaction announced]
Endpoint: http://localhost:3000/transaction/C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB
Hash:     C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB
Signer:   64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0

[UNCONFIRMED] SCGUWZ...
{"type":16712,"networkType":144,"version":1,"deadline":{"value":"2019-03-25T00:22:43.013"},"fee":{"lower":0,"higher":0},"signature":"574F80482FE348003E86CB0497596B6E1E3635F2B846D95CCA983E2161D709B76ABCBFF3EF7768B1671741D37354699A853715B4888BB5E907B926F5439F2A05","signer":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB","merkleComponentHash":"C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB"},"mosaic":{"id":{"id":{"lower":1812672056,"higher":2097790768}},"amount":{"lower":10000000,"higher":0}},"duration":{"lower":480,"higher":0},"hash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D"}

[CONFIRMED] SCGUWZ...
{"type":16712,"networkType":144,"version":1,"deadline":{"value":"2019-03-25T00:22:43.013"},"fee":{"lower":0,"higher":0},"signature":"574F80482FE348003E86CB0497596B6E1E3635F2B846D95CCA983E2161D709B76ABCBFF3EF7768B1671741D37354699A853715B4888BB5E907B926F5439F2A05","signer":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}},"transactionInfo":{"height":{"lower":8711,"higher":0},"hash":"C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB","merkleComponentHash":"C3DE086FDBD6C8A1E10C09D3D8F635A6B1DA778C27843CA5FAC47DEB419E71BB"},"mosaic":{"id":{"id":{"lower":1812672056,"higher":2097790768}},"amount":{"lower":10000000,"higher":0}},"duration":{"lower":480,"higher":0},"hash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D"}

[AGGREGATE_BONDED_ADDED] SCGUWZ...
{"type":16961,"networkType":144,"version":2,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D","merkleComponentHash":"0000000000000000000000000000000000000000000000000000000000000000"},"innerTransactions":[{"type":16724,"networkType":144,"version":3,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6","address":{"address":"SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A","networkType":144}},"recipient":{"address":"SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM","networkType":144},"mosaics":[{"id":{"id":{"lower":3294802500,"higher":2243684972}},"amount":{"lower":1000000,"higher":0}}],"message":{"type":0,"payload":""}}],"cosignatures":[]}

[COSIGNATURE_ADDED] SCGUWZ...
{"parentHash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D","signature":"311534CF2BC6B1C24E3A6B999C38DE3291B726210E19796D6B5F580E5A23AA99E5978913D727B070EB7709081EDC4B9BF36A86D53AA300956BB343716316D20E","signer":"7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8"}

[UNCONFIRMED] SCGUWZ...
{"type":16961,"networkType":144,"version":2,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D","merkleComponentHash":"889917138407628DF386D5E6434414A460E6EAA8DD07F7E22FE2B9B653243DAE"},"innerTransactions":[{"type":16724,"networkType":144,"version":3,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6","address":{"address":"SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A","networkType":144}},"recipient":{"address":"SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM","networkType":144},"mosaics":[{"id":{"id":{"lower":3294802500,"higher":2243684972}},"amount":{"lower":1000000,"higher":0}}],"message":{"type":0,"payload":""}}],"cosignatures":[{"signature":"311534CF2BC6B1C24E3A6B999C38DE3291B726210E19796D6B5F580E5A23AA99E5978913D727B070EB7709081EDC4B9BF36A86D53AA300956BB343716316D20E","signer":{"publicKey":"7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8","address":{"address":"SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG","networkType":144}}}]}

[CONFIRMED] SCGUWZ...
{"type":16961,"networkType":144,"version":2,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}},"transactionInfo":{"height":{"lower":8713,"higher":0},"hash":"EBDCD709A41BF5100E20A63EA73A536C3704C9B74C9F6D2248509BD7783A829D","merkleComponentHash":"889917138407628DF386D5E6434414A460E6EAA8DD07F7E22FE2B9B653243DAE"},"innerTransactions":[{"type":16724,"networkType":144,"version":3,"deadline":{"value":"2019-03-25T00:22:41.288"},"fee":{"lower":0,"higher":0},"signature":"6B7EFA559701E4C63367C80F5447DFD2978D5838055EF44C2BD3EAB31AE5EEEEFF23FF494FA2464FDA614F8A312F225DB59EC10422F24DA61D225AB91FA5EB08","signer":{"publicKey":"F5B9256485A4BDD4ACD713D8A95BAB38E83B22934E8B8C6A74285B060413FAD6","address":{"address":"SDGQ6RTCBE7S3LTTXG7YVMABXHJTZDCF3JWE5R7A","networkType":144}},"recipient":{"address":"SBFMZE43WQ255UPU7OHRAGZ6S3SFGEK7NZ4AKCBM","networkType":144},"mosaics":[{"id":{"id":{"lower":3294802500,"higher":2243684972}},"amount":{"lower":1000000,"higher":0}}],"message":{"type":0,"payload":""}}],"cosignatures":[{"signature":"311534CF2BC6B1C24E3A6B999C38DE3291B726210E19796D6B5F580E5A23AA99E5978913D727B070EB7709081EDC4B9BF36A86D53AA300956BB343716316D20E","signer":{"publicKey":"7CDFDE511E145E4B17292AC268B2AD493B30C3AB060EBC53F753661C4BC06AC8","address":{"address":"SBV46LBDJZGKETWYS56ZT2VV4RCOMHKA3NTNUQSG","networkType":144}}}]}
```

流れとしては、受信者のアドレスへの転送トランザクションを作り、アグリゲートトランザクションの公開アカウントとしてマルチシグアカウントを渡します。

アグリゲートボンドトランザクションなので、LockFundsトランザクションを発行します。

LockFundsが承認されたらアグリゲートボンドトランザクションを発行します。

アグリゲートボンドトランザクションが承認されたら、連署者がそれに署名をすることで2名が署名したことになるので、転送トランザクションが承認されます。


### コード解説

```javascript
// マルチシグトランザクションはアグリゲートボンドトランザクションとして行う
const multisigTx = nem.AggregateTransaction.createBonded(
  nem.Deadline.create(),
  [transferTx.toAggregate(multisig)],
  nem.NetworkType.MIJIN_TEST
);
const signedMultisigTx = initiater.sign(multisigTx);
```

マルチシグトランザクションを発行するにはアグリゲートボンドトランザクションを使います。

```javascript
util.listener(url, initiater.address, {
  onConfirmed: () => {
    util.announceAggregateBonded(url, signedMultisigTx);
  },
  onAggregateBondedAdded: (aggregateTx) => {
    const cosignatureTx = nem.CosignatureTransaction.create(aggregateTx)
    const signedCosignatureTx = cosignator.signCosignatureTransaction(cosignatureTx)
    util.announceAggregateBondedCosignature(url, signedCosignatureTx)
  }
});
```

本来であれば、連署者は自分に届いた署名待ちのトランザクション一覧を取得し署名をするべきです。

ここでは便宜上、アグリゲートトランザクションが承認されたタイミングで連署者に署名をさせています。

以降はアグリゲートボンドトランザクションのためのLockFundsトランザクションの処理を行っています。


## マルチレベルマルチシグの構築

`Catapult`ではマルチシグアカウントを別のマルチシグアカウントの連署者として追加できるようになりました。

これにより、マルチシグ承認を階層化できるようになりました。

- [マルチレベルマルチシグアカウントの作成 \(MLMA\) — NEM Developer Center](https://nemtech.github.io/ja/guides/account/creating-a-multi-level-multisig-account.html)

MLMSを構築する際に特別な方法は必要とせず、単にマルチシグ連署者としてマルチシグアカウントを指定すればよいだけです。


### MLMSの作成

`scripts/multisig/setup_mlms.js`を実行してください。

このスクリプトはアカウントを5つ生成し、そのうち1つをトップのマルチシグアカウントに、2つを2階層目のアカウントに、残りの2つを片方の2階層目の連署者に、

もう片方の2階層目の連署者には、環境変数に設定された秘密鍵のアカウントと引数で渡した公開鍵のアカウントを設定します。

```shell
$ node scripts/multisig/setup_mlms.js 8F6A78A6FD538001145F56082B318C838210E9B3FC8151906E5F714AD7CEF840
Initiater: SCGUWZ-FCZDKI-QCACJH-KSMRT7-R75VY6-FQGJOU-EZN5
Endpoint:  http://localhost:3000/account/SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5

Root Multisig Account
Private:  4150EE61F4E3B6DD327C43DC6B72EC3895A99CB71F618661C7ACD40DF2534817
Public:   5FDA91C2C8988C606512B8D8FED9214DD16E288D444C06D57F5740A67389676F
Address:  SBK4KX-ICFNFZ-BZS6NR-XVYMLS-7NOBEX-MLILBK-KIOE
Endpoint: http://localhost:3000/account/SBK4KXICFNFZBZS6NRXVYMLS7NOBEXMLILBKKIOE
Endpoint: http://localhost:3000/account/SBK4KXICFNFZBZS6NRXVYMLS7NOBEXMLILBKKIOE/multisig
Endpoint: http://localhost:3000/account/SBK4KXICFNFZBZS6NRXVYMLS7NOBEXMLILBKKIOE/multisig/graph

Left Multisig Account
Private:  09B8E081D276887597877BB9EA6825661F86687FCAD2BF1EEE85AD5C8DA55330
Public:   9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6
Address:  SB2TJ2-YX24KF-NC4XPG-CNW4W7-QBQI6Z-XR2CAR-73WF
Endpoint: http://localhost:3000/account/SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF
Endpoint: http://localhost:3000/account/SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF/multisig
Endpoint: http://localhost:3000/account/SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF/multisig/graph

Right Multisig Account
Private:  DEC71E5DD73B3750F52025CF7B923CFE09FBF1A1D1CDB47EAB6F5C2DD97008CD
Public:   03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55
Address:  SD7DP6-GE7JGN-CIQRUH-PBOGJ5-T2C4SV-3ZLB3B-Z3E7
Endpoint: http://localhost:3000/account/SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7
Endpoint: http://localhost:3000/account/SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7/multisig
Endpoint: http://localhost:3000/account/SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7/multisig/graph

Left Cosigner Account1:
Private:  A080ADC06DA7927AA87DF2069807AEFE1B13515DD295088A9D0E30EF3A0F7990
Public:   6231C3C1E26CFB11E83D8BBB782D258F1E2048D65E2A41186B59AA6CBD41A332
Address:  SD54SD-KEOWWB-UU37J4-NKFKZT-WVCSEF-MN2XAU-NVC6
Endpoint: http://localhost:3000/account/SD54SDKEOWWBUU37J4NKFKZTWVCSEFMN2XAUNVC6
Endpoint: http://localhost:3000/account/SD54SDKEOWWBUU37J4NKFKZTWVCSEFMN2XAUNVC6/multisig
Endpoint: http://localhost:3000/account/SD54SDKEOWWBUU37J4NKFKZTWVCSEFMN2XAUNVC6/multisig/graph

Left Cosigner Account2:
Private:  9626BA21B5BC280F76A3844AB13266F9FA9855CFA887B4478332EF082C0AFF0C
Public:   9DBCBB48D9D5B7B1D49D2E8A655BC6014B6F10D42BFC3AE030FC8A31E403FD32
Address:  SAI6D7-AELD6A-PBKV2G-MJMBQN-NZMREF-QKCEV7-LGJV
Endpoint: http://localhost:3000/account/SAI6D7AELD6APBKV2GMJMBQNNZMREFQKCEV7LGJV
Endpoint: http://localhost:3000/account/SAI6D7AELD6APBKV2GMJMBQNNZMREFQKCEV7LGJV/multisig
Endpoint: http://localhost:3000/account/SAI6D7AELD6APBKV2GMJMBQNNZMREFQKCEV7LGJV/multisig/graph

connection open
connection open
connection open
[Transaction announced]
Endpoint: http://localhost:3000/transaction/3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6
Hash:     3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6
Signer:   9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6

[Transaction announced]
Endpoint: http://localhost:3000/transaction/6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91
Hash:     6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91
Signer:   5FDA91C2C8988C606512B8D8FED9214DD16E288D444C06D57F5740A67389676F

[Transaction announced]
Endpoint: http://localhost:3000/transaction/55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E
Hash:     55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E
Signer:   03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55

[UNCONFIRMED] SD7DP6...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.341"},"fee":{"lower":0,"higher":0},"signature":"0BC7D42B933E6430F23200ABC20FF902B0A54086F57CF8DCD5AD42EC02540EC1D241B2FC9E0A40EDC9A5A17457CE6F6ABE13D7FA6DBFC5DAC1F5502FEE3B2604","signer":{"publicKey":"03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55","address":{"address":"SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E","merkleComponentHash":"55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"8F6A78A6FD538001145F56082B318C838210E9B3FC8151906E5F714AD7CEF840","address":{"address":"SBVNFWUJBTQ6PS2SGRDJLYL2SGNFB4IBBKYPELOB","networkType":144}}}]}

[UNCONFIRMED] SBK4KX...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.342"},"fee":{"lower":0,"higher":0},"signature":"5B6582E829C28DEDDBBA7135B2A232DF34F64562B9769BE998A89BF77EA6CC2172BC48C8EA0E66D56B11DC3F0AE92AF20FDAC1465BE1009E056C76B9E8793B0D","signer":{"publicKey":"5FDA91C2C8988C606512B8D8FED9214DD16E288D444C06D57F5740A67389676F","address":{"address":"SBK4KXICFNFZBZS6NRXVYMLS7NOBEXMLILBKKIOE","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91","merkleComponentHash":"6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6","address":{"address":"SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55","address":{"address":"SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7","networkType":144}}}]}

[UNCONFIRMED] SB2TJ2...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.324"},"fee":{"lower":0,"higher":0},"signature":"3653F55489DBF19AD8AF45F254173A269F89C6936881C1003122FA8DCA6949DA68B1DE7E5F6C6E62275A779AE3FB54AFB07845F752458C0E0B02A56E674CB407","signer":{"publicKey":"9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6","address":{"address":"SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF","networkType":144}},"transactionInfo":{"height":{"lower":0,"higher":0},"hash":"3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6","merkleComponentHash":"3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6"},"minApprovalDelta":1,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"6231C3C1E26CFB11E83D8BBB782D258F1E2048D65E2A41186B59AA6CBD41A332","address":{"address":"SD54SDKEOWWBUU37J4NKFKZTWVCSEFMN2XAUNVC6","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"9DBCBB48D9D5B7B1D49D2E8A655BC6014B6F10D42BFC3AE030FC8A31E403FD32","address":{"address":"SAI6D7AELD6APBKV2GMJMBQNNZMREFQKCEV7LGJV","networkType":144}}}]}

[CONFIRMED] SBK4KX...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.342"},"fee":{"lower":0,"higher":0},"signature":"5B6582E829C28DEDDBBA7135B2A232DF34F64562B9769BE998A89BF77EA6CC2172BC48C8EA0E66D56B11DC3F0AE92AF20FDAC1465BE1009E056C76B9E8793B0D","signer":{"publicKey":"5FDA91C2C8988C606512B8D8FED9214DD16E288D444C06D57F5740A67389676F","address":{"address":"SBK4KXICFNFZBZS6NRXVYMLS7NOBEXMLILBKKIOE","networkType":144}},"transactionInfo":{"height":{"lower":5845,"higher":0},"hash":"6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91","merkleComponentHash":"6A9E881776374ADD4EAD0C066618FA55E358AF8478A984A880F670C2BACAFA91"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6","address":{"address":"SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55","address":{"address":"SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7","networkType":144}}}]}

[CONFIRMED] SD7DP6...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.341"},"fee":{"lower":0,"higher":0},"signature":"0BC7D42B933E6430F23200ABC20FF902B0A54086F57CF8DCD5AD42EC02540EC1D241B2FC9E0A40EDC9A5A17457CE6F6ABE13D7FA6DBFC5DAC1F5502FEE3B2604","signer":{"publicKey":"03C7223F64B39D2713A568B92B8041FB23F9B5FAB8E91BAB873E12C79F097A55","address":{"address":"SD7DP6GE7JGNCIQRUHPBOGJ5T2C4SV3ZLB3BZ3E7","networkType":144}},"transactionInfo":{"height":{"lower":5845,"higher":0},"hash":"55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E","merkleComponentHash":"55AE03F16C754A6F16E2822E9B380FECF2D07F252AA3700D3108A13D3EF6A95E"},"minApprovalDelta":2,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"64DFE4120D0F960C6602B9386542768556D2CD5242975F37837C8C5F238C78C0","address":{"address":"SCGUWZFCZDKIQCACJHKSMRT7R75VY6FQGJOUEZN5","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"8F6A78A6FD538001145F56082B318C838210E9B3FC8151906E5F714AD7CEF840","address":{"address":"SBVNFWUJBTQ6PS2SGRDJLYL2SGNFB4IBBKYPELOB","networkType":144}}}]}

[CONFIRMED] SB2TJ2...
{"type":16725,"networkType":144,"version":3,"deadline":{"value":"2019-03-24T00:27:25.324"},"fee":{"lower":0,"higher":0},"signature":"3653F55489DBF19AD8AF45F254173A269F89C6936881C1003122FA8DCA6949DA68B1DE7E5F6C6E62275A779AE3FB54AFB07845F752458C0E0B02A56E674CB407","signer":{"publicKey":"9ECAB480202F371403977F465150B5D363CCB3856AC2F5723036E175379014D6","address":{"address":"SB2TJ2YX24KFNC4XPGCNW4W7QBQI6ZXR2CAR73WF","networkType":144}},"transactionInfo":{"height":{"lower":5845,"higher":0},"hash":"3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6","merkleComponentHash":"3A57AA96CD5424E8BF9D6393A01A9A6872A21062229581D5269EB8738B50A5D6"},"minApprovalDelta":1,"minRemovalDelta":2,"modifications":[{"type":0,"cosignatoryPublicAccount":{"publicKey":"6231C3C1E26CFB11E83D8BBB782D258F1E2048D65E2A41186B59AA6CBD41A332","address":{"address":"SD54SDKEOWWBUU37J4NKFKZTWVCSEFMN2XAUNVC6","networkType":144}}},{"type":0,"cosignatoryPublicAccount":{"publicKey":"9DBCBB48D9D5B7B1D49D2E8A655BC6014B6F10D42BFC3AE030FC8A31E403FD32","address":{"address":"SAI6D7AELD6APBKV2GMJMBQNNZMREFQKCEV7LGJV","networkType":144}}}]}
```

トランザクションが承認されたらURLにアクセスしてみましょう。


#### コード解説

マルチシグアカウントに別のマルチシグアカウントを連署者を追加するだけです。

このコードでも、便宜上コード内でアカウントを生成して、MLMSを構築します。

同様に必要があればリダイレクトや`tee`コマンドで秘密鍵を保存してください。

マルチシグレベルマルチシグの階層構造は`/account/{address}/multisig/graph`のAPIにアクセスすることで取得できます。
